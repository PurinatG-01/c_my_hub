name: PR Comment

on:
  workflow_run:
    workflows: ["PR Checks"]
    types:
      - completed

permissions:
  pull-requests: write
  issues: write

jobs:
  comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion != 'skipped'

    steps:
      - name: Download results
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          name: pr-check-results
          path: ./pr-results

      - name: Read results
        id: results
        run: |
          echo "analyze_status=$(cat ./pr-results/analyze-status.txt)" >> $GITHUB_OUTPUT
          echo "security_status=$(cat ./pr-results/security-status.txt)" >> $GITHUB_OUTPUT
          echo "pr_number=$(cat ./pr-results/pr-number.txt)" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const analyzeStatus = '${{ steps.results.outputs.analyze_status }}';
            const securityStatus = '${{ steps.results.outputs.security_status }}';
            const prNumber = parseInt('${{ steps.results.outputs.pr_number }}');

            let emoji = '✅';
            let status = 'passed';

            if (analyzeStatus === 'failure' || securityStatus === 'failure') {
              emoji = '❌';
              status = 'failed';
            } else if (analyzeStatus === 'cancelled' || securityStatus === 'cancelled') {
              emoji = '⏸️';
              status = 'cancelled';
            }

            const comment = `## ${emoji} PR Checks Summary

            **Status:** ${status.toUpperCase()}

            | Check | Status |
            |-------|--------|
            | Code Analysis & Tests | ${analyzeStatus === 'success' ? '✅ Passed' : analyzeStatus === 'failure' ? '❌ Failed' : '⏸️ ' + analyzeStatus} |
            | Security & Dependencies | ${securityStatus === 'success' ? '✅ Passed' : securityStatus === 'failure' ? '❌ Failed' : '⏸️ ' + securityStatus} |

            ${analyzeStatus === 'failure' || securityStatus === 'failure' ? 
              '**Please check the failed jobs and fix the issues before merging.**' : 
              '**All checks passed! This PR is ready for review.**'}

            ---
            <sub>Generated by GitHub Actions - [View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.event.workflow_run.id }})</sub>`;

            // Find existing comment and update it, or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Checks Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log('Created new comment');
            }
