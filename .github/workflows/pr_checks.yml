name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, edited]

  # Also run on PR target branch changes
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

  # Allow manual trigger for testing
  workflow_dispatch:

# Prevent multiple runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze & Test
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.1"
          channel: "stable"
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Verify dependencies
        run: flutter pub deps

      - name: Generate code (if needed)
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            flutter packages pub run build_runner build --delete-conflicting-outputs
          fi

      - name: Check formatting
        run: |
          echo "Checking Dart code formatting..."
          if ! dart format --set-exit-if-changed --line-length 80 .; then
            echo "❌ Code is not properly formatted"
            echo "Run 'dart format .' locally to fix formatting issues"
            exit 1
          else
            echo "✅ Code is properly formatted"
          fi

      - name: Analyze code
        run: |
          echo "Running Flutter analyze..."
          flutter analyze --fatal-infos --fatal-warnings
          if [ $? -eq 0 ]; then
            echo "✅ No analysis issues found"
          else
            echo "❌ Analysis issues detected"
            exit 1
          fi

      - name: Run tests
        run: |
          echo "Running Flutter tests..."
          flutter test --coverage --reporter=expanded
          if [ $? -eq 0 ]; then
            echo "✅ All tests passed"
          else
            echo "❌ Some tests failed"
            exit 1
          fi

      - name: Check test coverage
        run: |
          if [ -f "coverage/lcov.info" ]; then
            echo "Test coverage report generated successfully"
            # You can add coverage threshold checks here if needed
            # For example, to ensure minimum 80% coverage:
            # genhtml coverage/lcov.info -o coverage/html
            # lcov --summary coverage/lcov.info
          else
            echo "No coverage report generated"
          fi

      - name: Upload coverage reports
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Build APK (Debug)
        run: |
          echo "Building debug APK..."
          flutter build apk --debug
          if [ $? -eq 0 ]; then
            echo "✅ Debug APK built successfully"
          else
            echo "❌ Failed to build debug APK"
            exit 1
          fi

      - name: Build iOS (Debug)
        run: |
          echo "Building iOS version..."
          flutter build ios --debug --no-codesign
          if [ $? -eq 0 ]; then
            echo "✅ iOS build completed successfully"
          else
            echo "❌ Failed to build iOS version"
            exit 1
          fi

  # Additional job for security and dependency checks
  security-checks:
    name: Security & Dependencies
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.1"
          channel: "stable"
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check for outdated packages
        run: |
          echo "Checking for outdated packages..."
          flutter pub outdated --no-dev-dependencies --no-dependency-overrides
          echo "ℹ️  Review outdated packages above (this is informational only)"

      - name: Audit dependencies
        run: |
          echo "Running pub audit for security vulnerabilities..."
          dart pub audit || echo "⚠️  Security audit completed with warnings (review above)"

      - name: Validate pubspec.yaml
        run: |
          echo "Validating pubspec.yaml..."
          flutter pub deps --json > /dev/null
          if [ $? -eq 0 ]; then
            echo "✅ pubspec.yaml is valid"
          else
            echo "❌ pubspec.yaml validation failed"
            exit 1
          fi

  # Comment on PR with results summary
  pr-comment:
    name: PR Summary Comment
    runs-on: ubuntu-latest
    needs: [analyze, security-checks]
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const analyzeStatus = '${{ needs.analyze.result }}';
            const securityStatus = '${{ needs.security-checks.result }}';

            let emoji = '✅';
            let status = 'passed';

            if (analyzeStatus === 'failure' || securityStatus === 'failure') {
              emoji = '❌';
              status = 'failed';
            } else if (analyzeStatus === 'cancelled' || securityStatus === 'cancelled') {
              emoji = '⏸️';
              status = 'cancelled';
            }

            const comment = `## ${emoji} PR Checks Summary

            **Status:** ${status.toUpperCase()}

            | Check | Status |
            |-------|--------|
            | Code Analysis & Tests | ${analyzeStatus === 'success' ? '✅ Passed' : analyzeStatus === 'failure' ? '❌ Failed' : '⏸️ ' + analyzeStatus} |
            | Security & Dependencies | ${securityStatus === 'success' ? '✅ Passed' : securityStatus === 'failure' ? '❌ Failed' : '⏸️ ' + securityStatus} |

            ${analyzeStatus === 'failure' || securityStatus === 'failure' ? 
              '**Please check the failed jobs and fix the issues before merging.**' : 
              '**All checks passed! This PR is ready for review.**'}

            ---
            <sub>Generated by GitHub Actions</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
